<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø Green Hill Canarias - AI Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-green-800 mb-4">
                üåø Green Hill Canarias ‚Äî AI Portal
            </h1>
            <p class="text-lg text-gray-600">Digital Twin empresarial basado en DigitalRoots LangGraph</p>
        </header>

        <!-- Selector de Audiencia -->
        <div class="max-w-2xl mx-auto mb-8">
            <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Audiencia:</label>
            <select id="audience" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                <option value="public">üåç Public - Informaci√≥n general</option>
                <option value="investor">üí∞ Investor - M√©tricas financieras</option>
                <option value="boardroom">üëî Boardroom - Decisiones ejecutivas</option>
            </select>
        </div>

        <!-- Chat Panel -->
        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üí¨ Chat con el Digital Twin</h2>
            
            <div id="messages" class="bg-gray-50 rounded-lg p-4 mb-4 min-h-[200px] max-h-[400px] overflow-y-auto">
                <div class="text-gray-500 text-center">Haz tu primera pregunta para comenzar...</div>
            </div>
            
            <div class="flex gap-2">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Escribe tu pregunta aqu√≠..." 
                    class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                    onkeypress="handleKeyPress(event)"
                >
                <button 
                    onclick="sendMessage()" 
                    class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors"
                    id="sendButton"
                >
                    <i class="fas fa-paper-plane"></i> Enviar
                </button>
            </div>
        </div>

        <!-- Status Panel -->
        <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üìä Estado del Sistema</h2>
            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">CLI Directo:</span>
                    <span class="text-green-600 font-medium">‚úÖ Funcionando</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">DigitalRoots:</span>
                    <span class="text-green-600 font-medium">‚úÖ Conectado</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">GitHub Pages:</span>
                    <span class="text-green-600 font-medium">‚úÖ Desplegado</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500">
            <p>Desarrollado para Green Hill Canarias | Powered by DigitalRoots LangGraph</p>
            <p class="mt-2">
                <a href="https://github.com/ZAKIBAYDOUN/GHC-DT" target="_blank" class="text-green-600 hover:underline">
                    <i class="fab fa-github"></i> Ver en GitHub
                </a>
            </p>
        </footer>
    </div>

    <script>
        // Configuraci√≥n del backend - probando m√∫ltiples URLs
        const BACKEND_URLS = [
            'https://potential-zebra-w9g57rw7rj525g6v-8001.app.github.dev',
            'https://zakibaydoun-ghc-dt.vercel.app/api',
            'http://127.0.0.1:8001'
        ];
        
        // Funci√≥n para probar conectividad
        async function findWorkingBackend() {
            for (const url of BACKEND_URLS) {
                try {
                    const response = await fetch(`${url}/api/health`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    if (response.ok) {
                        return url;
                    }
                } catch (e) {
                    console.log(`Backend ${url} no disponible`);
                }
            }
            return null;
        }
        
        let BACKEND_URL = null;
        
        // Estado de la aplicaci√≥n
        let messages = [];

        // Funci√≥n para enviar mensaje
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const audience = document.getElementById('audience').value;
            const question = input.value.trim();
            
            if (!question) return;

            // Verificar backend disponible
            if (!BACKEND_URL) {
                BACKEND_URL = await findWorkingBackend();
                if (!BACKEND_URL) {
                    addMessage('system', 'Error: No se pudo conectar a ning√∫n backend disponible');
                    return;
                }
            }

            // Deshabilitar entrada mientras se procesa
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            document.getElementById('sendButton').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            // Agregar mensaje del usuario
            addMessage('user', question);
            input.value = '';

            try {
                // Llamar al backend
                const response = await fetch(`${BACKEND_URL}/api/ask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        audience: audience,
                        question: question
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    // Agregar respuesta del asistente
                    addMessage('assistant', data.final_answer || JSON.stringify(data, null, 2));
                } else {
                    addMessage('system', `Error ${response.status}: Backend no disponible`);
                }
            } catch (error) {
                addMessage('system', `Error de conexi√≥n: ${error.message}`);
                // Reintentar encontrar backend
                BACKEND_URL = null;
            }

            // Rehabilitar entrada
            input.disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('sendButton').innerHTML = '<i class="fas fa-paper-plane"></i> Enviar';
            input.focus();
        }

        // Funci√≥n para agregar mensaje al chat
        function addMessage(sender, content) {
            const messagesDiv = document.getElementById('messages');
            
            // Limpiar mensaje inicial si es el primer mensaje
            if (messages.length === 0) {
                messagesDiv.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${sender === 'user' ? 'text-right' : 'text-left'}`;
            
            let bgColor, textColor, icon;
            if (sender === 'user') {
                bgColor = 'bg-green-600';
                textColor = 'text-white';
                icon = 'üë§';
            } else if (sender === 'assistant') {
                bgColor = 'bg-gray-600';
                textColor = 'text-white';
                icon = 'ü§ñ';
            } else {
                bgColor = 'bg-red-100';
                textColor = 'text-red-800';
                icon = '‚ö†Ô∏è';
            }

            messageDiv.innerHTML = `
                <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${bgColor} ${textColor}">
                    <div class="font-medium mb-1">${icon} ${sender === 'user' ? 'T√∫' : sender === 'assistant' ? 'GHC Digital Twin' : 'Sistema'}</div>
                    <div class="text-sm whitespace-pre-wrap">${content}</div>
                </div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            messages.push({ sender, content });
        }

        // Manejar Enter en el input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('messageInput').focus();
            
            // Buscar backend disponible
            addMessage('system', 'üîç Buscando backend disponible...');
            BACKEND_URL = await findWorkingBackend();
            
            if (BACKEND_URL) {
                addMessage('system', `‚úÖ Conectado a: ${BACKEND_URL}`);
                setTimeout(() => {
                    addMessage('system', '¬°Bienvenido al Digital Twin de Green Hill Canarias! Selecciona tu audiencia y haz una pregunta.');
                }, 1000);
            } else {
                addMessage('system', '‚ùå No se encontr√≥ ning√∫n backend disponible. El chat no funcionar√°.');
            }
        });
    </script>
</body>
</html>